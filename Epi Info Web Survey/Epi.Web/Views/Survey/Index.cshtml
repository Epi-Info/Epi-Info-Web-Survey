@model MvcDynamicForms.Form
@{
    ViewBag.Title = "Survey";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@*<script src="../../Scripts/jquery-1.5.1-vsdoc.js" type="text/javascript"></script>*@

<script type="text/javascript">
 
    //Check Code Logic start
     @Html.Raw(Model.FormJavaScript)
    //Check code logic end

 



</script>
   
   <script type="text/javascript">

   $(function () {
           $("#savediv button[title]").tooltip();
       });
 </script>  
<script type="text/javascript">

     
    /*Clicking the save button to save the survey*/
    function Save() {
        //debugger;
        //set the is_save_action hidden variable value to true to indicate that save button has been clicked
        $("#myform")[0].is_save_action.value = 'true';
        //set the action path of the current form so when it is submitted by clicking the save button it posts to the path 
        $("#myform")[0].action = window.location.href;
        //detach the validation engine as we don't want to validate data on save button click
        $('#myform').validationEngine('detach');
        //posting the form
        $('#myform').submit();
        // return false;

    }
    /*Clicking the continue button*/

    function Continue() {
        //debugger;
        var presentUrl;
        var pageNumber;
        var actionUrlC;
        presentUrl = '@Url.Action("Index","Survey")';
        pageNumber = '@Model.CurrentPage';
        actionUrlC = processUrl(presentUrl, 'ContinueUrl', pageNumber);
        $("#myform")[0].action = actionUrlC;
        $("#myform").submit();
        
    }
    
    /*Clicking the previous button*/
    function Previous() {
        //debugger;
        var presentUrl;
        var pageNumber;
        var actionUrlP;
        presentUrl = '@Url.Action("Index","Survey")';
        pageNumber = '@Model.CurrentPage';
        actionUrlP = processUrl(presentUrl, 'PreviousUrl', pageNumber);
        $("#myform")[0].action = actionUrlP;
        $("#myform").submit();
    }


    $(document).ready(function () {
        // a workaround for a flaw in the demo system (http://dev.jqueryui.com/ticket/4375), ignore!
        
        //$("#Savebutton").tooltip();


        $("#dialog").dialog({
            autoOpen: false,
            show: "blind",
            hide: "blind",
            resizable: false,
            height: 370,
            modal: true
        });
        var responseUrl = GetRedirectionUrl();
        $('#url').val(responseUrl);

        var passcode = '@Model.PassCode';
        $('#spPassCode').text(passcode);

        if ('@Model.IsSaved' == 'True') {

            if ('@Model.StatusId' == '1') { //if clicking the save button for the first time
                $('#successContent').show();
                $('#successContent').append('<div class="success"><img src="@Url.Content("~/Content/images/button_check.png")" style="vertical-align:middle; padding-right: 10px;" alt=""/> Your survey has been saved.<button id="copy" type="button" name="copy" class="copylink">Get Survey Link & Pass Code</button></div>')

                

                //call your jquery modal popup method
                $("#dialog").dialog("open");
                
            }
            else {

                

                $('#successContent').show(); //in subsequest click we just show that the survey has been saved not the modal popup
                $('#successContent').append('<div class="success"><img src="@Url.Content("~/Content/images/button_check.png")" style="vertical-align:middle; padding-right: 10px;" alt=""/> Your survey has been saved.<button id="copy" type="button" name="copy" class="copylink">Get Survey Link & Pass Code</button></div>')
            }
            return true;
        }

    });

    $(document).ready(function () {

        $("#send").click(function () {

            var emailAddress = $("#email").val();
            var confirmemail = $("#confirmemail").val();
            var redirectUrl = GetRedirectionUrl();
            //var surveyName = $("#_surveyName").val();
            var surveyName = '@Model.SurveyInfo.SurveyName';
            var passCode = $('#spPassCode').text();
            //url to post for email to be sent
            var postUrl = '@Url.Action("Notify","Post")';
            if (ValidateEmail(emailAddress) && ValidateEmail(confirmemail)) {
                if ($.trim(emailAddress) == $.trim(confirmemail)) {
                    //Call notify function to send notification
                    NotifyByEmail(emailAddress, redirectUrl, surveyName, postUrl, passCode);
                    //close the modal popup after processing
                    $("#dialog").dialog("close");
                }
                else {
                    alert("The email address did not match.");
                }

            }
            else {
                // $('#email').after('<span class="error">Enter a valid email address.</span>');
                alert('Enter a valid email address!');
            }
        });

        /*Exit the survey */
        $("#close").click(function () {
            
            var signoutUrl = '@Url.Action("SignOut","Post")';
            var homePageUrl = '@Url.Action("Index","Home")' + '/' + '@Model.SurveyInfo.SurveyId'; //'http://wwwn.cdc.gov/epiinfo/';
            SignOutAndRedirect(signoutUrl, homePageUrl);
        });


        /*Open the modal popup on link click*/
        $('#copy').click(function () {
            $("#dialog").dialog("open");
            $('#url').val(GetRedirectionUrl());
            return false;
        });



    });
 
 
 function updateXml(pName, pValue) {
 
   
            var UpdateUrl = '@Url.Action("UpdateResponseXml","Survey")';
           
            UpdateResponse(UpdateUrl,pName, pValue,'@Model.ResponseId');
            
            }
 
 
   
</script>

<div id="header">
            <h1>
                @Model.SurveyInfo.SurveyName 
                 
                </h1>
 </div>
 

    <div id="infobox">
        <div id="pages" class="pages">



         @if (Model.NumberOfPages > 0)
          {
              int num = 0;
              
              

             for (int i = 1; Model.NumberOfPages > i - 1; i++)
              {
                  
                  num = i;  
                    if (i == 1 && Model.CurrentPage >1)
                        {   
                             
                           
                           @*<a  style="background-image: url('@Url.Content("~/Content/images/prev.png")'); background-repeat:no-repeat; background-position:center; width:13px;"   href="@string.Format("../../Survey/{0}/{1}", Model.ResponseId, Model.CurrentPage - 1)"    class="nextprev" title="Previous Page">
                          &nbsp;&nbsp;&nbsp;
                              </a>*@
                           <a  style="background-image: url('@Url.Content("~/Content/images/prev.png")'); background-repeat:no-repeat; background-position:center; width:13px;"   href="@Url.RouteUrl(null, new { controller = "Survey", action = "Index", responseid = Model.ResponseId, PageNumber = Model.CurrentPage - 1 })"    class="nextprev" title="Previous Page">
                          &nbsp;&nbsp;&nbsp;
                              </a>  
                            
                        }




                    if (Model.CurrentPage == i)
                    {  
          <span class="current">@num</span>
          
                    }
                    else
                    {  

       
         
                    
                    
                    @Html.ActionLink(num.ToString(), "Index", "Survey", new { responseid = Model.ResponseId, PageNumber = num }, null)

                   
                    
                    }

              }

             if (Model.CurrentPage != Model.NumberOfPages)
             {  
                  
        @* <a  id="anchorNext"   style="background-image: url('@Url.Content("~/Content/images/next.png")');  background-repeat:no-repeat; background-position:center; width:13px;" href="@string.Format("../../Survey/{0}/{1}", Model.ResponseId, Model.CurrentPage + 1)" class="nextprev" title="Go to Next Page">
        &nbsp;&nbsp;&nbsp;
         </a>*@
          <a  id="anchorNext"   style="background-image: url('@Url.Content("~/Content/images/next.png")');  background-repeat:no-repeat; background-position:center; width:13px;" href="@Url.RouteUrl(null, new { controller = "Survey", action = "Index", responseid = Model.ResponseId, PageNumber = Model.CurrentPage + 1 })" class="nextprev" title="Go to Next Page">
        &nbsp;&nbsp;&nbsp;
         </a>      
            
          
             }

          } 


 
      
      </div>
	   
	  <div id="exit">
      <button class="exitsurvey" type="submit" id="close">Exit Survey</button>
      
      </div>
	  <div style="clear:both;"></div>
	 </div>

	<div id="content">
         <div id="successContent">
         
         </div>
     @if (!string.IsNullOrEmpty(Model.GetErrorSummary()))
     { 
        <div class="errormsg">
            
            <div class="image">
                <img src="@Url.Content("~/Content/images/error.png")" style="vertical-align: middle; padding-right: 10px;" alt=""/>
            </div>
            <div class="message">
              <span style="font-weight:bold; font-size:10pt;">Please correct the following errors before continuing:</span>
                <br/>
               
                 @Html.Raw(Model.GetErrorSummary())
            </div>
            <div style="clear: both;">
            </div>

        </div>
     } 
        @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "myform" }))
        {  
           
              
             @Html.AntiForgeryToken() 
             
             @Html.Raw(Model.RenderHtml(true))
            

             
           
            <input type="hidden"  id="HiddenFieldsList"  name="HiddenFieldsList" value="@Model.HiddenFieldsList" />
            <input type="hidden"  id="HighlightedFieldsList"  name="HighlightedFieldsList" value="@Model.HighlightedFieldsList" />
            <input type="hidden"  id="DisabledFieldsList"  name="DisabledFieldsList" value="@Model.DisabledFieldsList" />
             <input type="hidden"  id="AssignList"  name="AssignList" value="@Model.AssignList" />
   	        <input type="hidden"  name="is_save_action" value="false" />
            <input type="hidden"  name="is_goto_action" value="false" /> 
             
             
	        <div id="nav">
            <div id="prev" align="left">&nbsp;
             @if (Model.CurrentPage != 1)
             {  
		        
              
              
              <button class="prev" id="PreviousButton" value="PreviousButton" onclick="Previous();"  name="PreviousButton"  type="button" > &nbsp; Previous</button>
             }
             </div>
	 		 

             <div id="savediv" align="center">
             <button class="save"  title="Click this button to finish the survey later. Use the survey link and pass code provided to return to the survey at a later time." type="button" id ="Savebutton" onclick="Save();" name="Savebutton" value="save"> &nbsp; Finish later</button>
             </div>
                 
              
               @if (Model.CurrentPage == Model.NumberOfPages)
               {  
               <div id="next" align="right"> 
              <button class="submits" type="submit"  name="Submitbutton" value="Submit" >
              Submit Survey &nbsp; </button>
              </div>
               }
               else
               {
                   
                    <div id="next" align="right">
                    <button class="next"  name="ContinueButton" id="ContinueButton" onclick="Continue();" type="button" >Continue &nbsp; </button>
                    </div>
                                            
               }

              </div>    
           
        }
       
     </div>


     
    <div id="dialog" title="Your Survey has been saved.">
                   <p>Please copy and save the <span style="font-weight:bold;">Survey Link</span> and <span style="font-weight:bold;">Pass Code</span> in order to return to the survey at a later time.</p>
                <p><span style="font-weight:bold;">Survey Link:</span><br /><textarea id="url" cols="65"  style="  height:30px;  white-space:pre; background:#d6e7f5; border:1px solid #aecfea; padding:4px; margin-top:4px;" readonly="readonly"></textarea></p>
                
               <p style="font-weight:bold;">Pass Code: <span id="spPassCode" style="font-size:12pt; background:#d6e7f5; border:1px solid #aecfea; padding:4px 10px;"></span></p>
                  <hr/>
                  <p>Optionally enter your email address to have the Survey Link and Pass Code emailed to you.</p>
                  
               
                
                <p><label for="email">Email:</label> <input id="email" type="text" style="width: 200px; margin-left:48px;"/></p>
                  <p><label for="confirmemail">Confirm Email:</label> <input id="confirmemail" type="text" style="width: 200px;"/>
                  <button id="send" type="button" class="login" style="width:50px">Send</button></p>
                <br />
                <p style="font-size: 8pt; padding: 5px; background: #ffffa8; margin-top:-5px;"><strong>Note:</strong> Your email address will not be saved and will only be used to send you the survey link.</p>
               </div>

     
